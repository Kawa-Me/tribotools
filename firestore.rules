
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function para verificar se o usuário é um administrador.
    // Isso verifica se o documento do usuário existe e se o campo 'role' é 'admin'.
    function isAdmin() {
      return request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function para verificar se o usuário está autenticado.
    function isAuthenticated() {
      return request.auth != null;
    }

    // Coleção de Módulos:
    // - Qualquer usuário autenticado pode LER a lista de módulos.
    // - Apenas administradores podem ESCREVER (criar, editar, deletar) módulos.
    match /modules/{moduleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Coleção de Usuários:
    // - Usuários podem LER e ATUALIZAR seus próprios dados.
    // - Administradores podem LER e ATUALIZAR os dados de qualquer usuário.
    // - Administradores podem LISTAR todos os usuários.
    // - Um usuário pode CRIAR seu próprio documento ao se registrar.
    match /users/{userId} {
      allow get, update: if request.auth.uid == userId || isAdmin();
      allow list: if isAdmin();
      allow create: if isAuthenticated();
      // Nenhuma permissão de exclusão é concedida para segurança.
      allow delete: if false;
    }
  }
}
